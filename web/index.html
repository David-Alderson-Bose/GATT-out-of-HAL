<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="rubeusDemo.css" type="text/css">
<script type="text/javascript" src="./js/bundle.min.js"></script>
<script src="wsHelper.js"></script>
<style>
body {
background-color: #000000
}

.demoStage {
text-align: center;
color:white;
font-size:20px;
font-family:'Gotham';
}

.volumeLabel {
text-align: center;
color:white;
font-size:14px;
font-family:'Gotham';
}

.playVolumeValue {
text-align: center;
color:white;
font-size:14px;
font-family:'Gotham';
}

.accelDataValue {
text-align: center;
color:white;
font-size:14px;
font-family:'Gotham';
}

</style>
<meta charset="UTF-8">
<title>Rubeus Demo</title>
</head>
<body >
<h2 style="text-align:center;color:white;font-size:22;font-family:'Gotham'">Sleep Plan Demo</h1>
<p id="stageValue" class="demoStage">Press 1 + Aux</p>
<p class="volumeLabel"><b><u>Volume</u></b></p>
<p id="volumeValue" class="playVolumeValue">0</p>
<p id="accelData" class="accelDataValue"></p>


<script>
    // Update accelerometer data
    updateAccelData('000000000000000000000000');
    function updateAccelData(raw_data) {

        function scaleData(hex_str) {
            const MAX = 65535;
            const SCALE = 4;
            const OFFSET = 2;
            var value = parseInt(hex_str, 16) >> 0;
            var scaled = (value/MAX)*SCALE;
            if (scaled > OFFSET) {
                scaled -= SCALE;
            }
            var scaled_str = scaled.toFixed(3);
            if (!scaled_str.startsWith('-')) {
                scaled_str = scaled_str.replace(/^/, ' ') // Pad front of positive numbers
            }
            return scaled_str;
            //return hex_str
        }

        // new data should be 16-digit number represented as a string
        var clean_data = raw_data.padStart(24, '0');
        var LX = scaleData(clean_data.substring(0,4));    
        var LY = scaleData(clean_data.substring(4,8));    
        var LZ = scaleData(clean_data.substring(8,12));
        var RX = scaleData(clean_data.substring(12,16));
        var RY = scaleData(clean_data.substring(16,20));
        var RZ = scaleData(clean_data.substring(20,24));   
        var str_list = [  
            '<b><u>Accelerometer data</u></b><br><pre>',
            '<b>LX</b>: ', LX, ' <b>RX</b>: ', RX, '<br>',
            '<b>LY</b>: ', LY, ' <b>RY</b>: ', RY, '<br>',
            '<b>LZ</b>: ', LZ, ' <b>RZ</b>: ', RZ, '</pre>',
        ]
        document.getElementById("accelData").innerHTML = str_list.join('');
    }
    
    // Accelerometer websocket management!
    var ws_test = WebSocketTest();
    function WebSocketTest() {
        var ws;
        var reconnect = 0;   
        var periodicReq;     
        
        if ("WebSocket" in window) {
            ws = new WebSocket("ws://localhost:9998/derp");

            ws.onerror = function() {
                if (reconnect == 0) {
                    reconnect = setTimeout(connectRetry, 500);
                }
            }

            function connectRetry() {
                console.log("retryin'");
                if (ws.readyState === ws.OPEN || ws.readyState === ws.CONNECTING) {
                    ws.close();
                }
                clearTimeout(reconnect);
                reconnect = 0;
                WebSocketTest();
            }
        
            ws.onopen = function() {
               periodicReq = setInterval(reqFromServer, 250);
               clearTimeout(reconnect);
               console.log("opened");
            };

            function reqFromServer() {
                ws.send("doesn't matter, really");
            }
         
            ws.onmessage = function(evt) { 
                var received_msg = evt.data;
                updateAccelData(received_msg.toString(10));
            };

            ws.onclose = function() { 
               updateAccelData('000000000000000000000000');
               clearInterval(periodicReq);
               if (reconnect == 0) {
                    reconnect = setTimeout(connectRetry, 500);
                }

            };
        } else {
            alert("WebSocket NOT supported by your Browser!");
        }
    }
</script>


</body>
</html>

